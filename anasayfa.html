<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title data-tr="Sipariş Oluştur" data-ar="إنشاء طلب" data-en="Create Order">Sipariş Oluştur</title>

  <!-- CSS -->
  <style>
    :root{
      --gold:#d4af37; --gold-dark:#b8941f; --bg:#f5f7fa; --surface:#fff;
      --text:#2c3e50; --error:#e74c3c; --border:#e0e0e0;
      --g50:#e8f5e9; --g250:#ffebee; --g1000:#e3f2fd;
      --radius:12px; --shadow:0 4px 18px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    body{background:var(--bg);color:var(--text);padding-bottom:140px}
    /* NAVBAR */
    .navbar{position:sticky;top:0;z-index:900;background:var(--surface);box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;padding:10px 16px}
    .navbar-logo{height:40px;border-radius:8px}
    .nav-info{display:flex;align-items:center;gap:8px;font-size:.9rem;font-weight:600}
    .new-order-btn{background:var(--gold);color:#fff;border:none;border-radius:var(--radius);padding:8px 14px;font-size:.9rem;font-weight:700;cursor:pointer}

    /* ÜRÜN KARTLARI */
    .products{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;padding:12px}
    .card{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden;display:flex;flex-direction:column}
    .card img{width:100%;height:110px;object-fit:cover}
    .card-header{padding:8px;font-size:.95rem;font-weight:600;text-align:center}
    .card table{width:100%;font-size:.85rem;border-collapse:collapse;table-layout:fixed}
    .card th,.card td{width:33.33%;padding:6px 4px;text-align:center;border:1px solid var(--border)}
    .card th{font-weight:700;background:var(--bg)}
    .card input{width:100%;max-width:70px;padding:4px;font-size:.85rem;text-align:center;border:1px solid var(--border);border-radius:4px}
    .card .kg{font-weight:600}
    .card .total-row{font-weight:700;background:var(--bg);color:var(--gold)}
    /* renkli satırlar */
    .card .tr-50{background:var(--g50)}
    .card .tr-250{background:var(--g250)}
    .card .tr-1000{background:var(--g1000)}

    /* GRAMAJ TOPLAMLARI */
    .gram-totals{
      max-width:800px;margin:12px auto;padding:0 12px;
      display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px
    }
    .gram-card{
      background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);
      padding:10px;text-align:center;font-size:.9rem;font-weight:600
    }
    .gram-card.g-50{background:var(--g50)}
    .gram-card.g-250{background:var(--g250)}
    .gram-card.g-1000{background:var(--g1000)}
    .gram-card .val{color:var(--gold);font-size:1.1rem}

    /* GENEL TOPLAM ÇUBUĞU */
    .total-bar{
      position:fixed;bottom:0;left:0;right:0;z-index:999;
      background:var(--surface);box-shadow:0 -2px 10px rgba(0,0,0,.1);
      display:flex;flex-direction:column;gap:6px;padding:10px 16px;font-size:.9rem
    }
    .total-row{display:flex;justify-content:space-between;align-items:center}
    .total-bar .values{color:var(--gold);font-weight:700}
    .summary-btn{background:var(--gold);color:#fff;border:none;border-radius:var(--radius);padding:10px 16px;font-size:1rem;font-weight:700;cursor:pointer}

    /* DİL BUTONLARI */
    .lang-float{
      position:fixed;bottom:76px;right:16px;z-index:998;
      display:flex;gap:6px;background:rgba(255,255,255,.85);
      backdrop-filter:blur(6px);padding:6px;border-radius:30px;
      box-shadow:0 4px 18px rgba(0,0,0,.15)
    }
    .lang-float button{
      min-width:56px;height:36px;border:none;border-radius:18px;
      font-size:.8rem;font-weight:700;cursor:pointer;
      background:#fff;color:var(--text);transition:transform .2s
    }
    .lang-float button:active{transform:scale(.92)}
    .lang-float button.active{background:var(--gold);color:#fff}

    /* MODAL */
    .modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.5);align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .modal-content{background:var(--surface);border-radius:var(--radius);width:100%;max-width:420px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.2);display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;border-bottom:1px solid var(--border)}
    .modal-header h2{font-size:1.1rem}
    .close-modal{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text)}
    .modal-body{padding:16px;font-size:.9rem;line-height:1.5}
    .modal-footer{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border)}
    .modal-footer button{flex:1;padding:10px;border:none;border-radius:var(--radius);font-size:.9rem;font-weight:700;cursor:pointer}
    .save-btn{background:var(--gold);color:#fff}
    .wp-btn{background:#25D366;color:#fff}
    .excel-btn{background:#1e7e34;color:#fff}
  </style>
</head>
<body>

<!-- NAVBAR -->
<header class="navbar">
  <img src="img/adalyalogo.jpg" alt="Logo" class="navbar-logo">
  <div class="nav-info">
    <span id="customerName">---</span>
    <button class="new-order-btn" onclick="yeniSiparis()" data-tr="Yeni Sipariş" data-ar="طلب جديد" data-en="New Order">Yeni Sipariş</button>
    <button class="new-order-btn" onclick="kayitliSiparisler()" data-tr="Kayıtlı" data-ar="المسجلة" data-en="Saved">Kayıtlı</button>
  </div>
</header>

<!-- SİPARİŞ BİLGİLERİ -->
<section style="padding:12px;max-width:800px;margin:auto;">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
    <div>
      <label data-tr="Müşteri" data-ar="العميل" data-en="Customer">Müşteri</label>
      <input type="text" id="customer" placeholder="Müşteri" data-tr-placeholder="Müşteri" data-ar-placeholder="العميل" data-en-placeholder="Customer">
    </div>
    <div>
      <label data-tr="Sipariş Kodu" data-ar="رمز الطلب" data-en="Order Code">Sipariş Kodu</label>
      <input type="text" id="orderCode" placeholder="Otomatik" data-tr-placeholder="Otomatik" data-ar-placeholder="تلقائي" data-en-placeholder="Auto">
    </div>
  </div>
  <div style="margin-top:12px;display:flex;gap:12px;flex-wrap:wrap">
    <label style="display:flex;align-items:center;gap:6px;font-size:.9rem"><input type="radio" name="ship" value="road" checked> <span data-tr="Karayolu" data-ar="الطريق البري" data-en="Road">Karayolu</span></label>
    <label style="display:flex;align-items:center;gap:6px;font-size:.9rem"><input type="radio" name="ship" value="sea"> <span data-tr="Denizyolu" data-ar="البحرية" data-en="Sea">Denizyolu</span></label>
    <label style="display:flex;align-items:center;gap:6px;font-size:.9rem"><input type="radio" name="ship" value="air"> <span data-tr="Havayolu" data-ar="الجوية" data-en="Air">Havayolu</span></label>
  </div>
</section>

<!-- ÜRÜN KARTLARI -->
<main class="products" id="products"></main>

<!-- GRAMAJ TOPLAMLARI -->
<section class="gram-totals" id="gramTotals"></section>

<!-- GENEL TOPLAM ÇUBUĞU -->
<div class="total-bar">
  <div class="total-row">
    <span data-tr="Toplam Koli" data-ar="إجمالي الكولا" data-en="Total Carton">Toplam Koli</span>
    <span class="values" id="totalKoli">0</span>
  </div>
  <div class="total-row">
    <span data-tr="Toplam KG" data-ar="إجمالي الكيلو" data-en="Total KG">Toplam KG</span>
    <span class="values" id="totalKg">0</span>
  </div>
  <button class="summary-btn" onclick="showSummary()" data-tr="Özeti Gör" data-ar="عرض الملخص" data-en="Show Summary">Özeti Gör</button>
</div>

<!-- DİL BUTONLARI -->
<div class="lang-float">
  <button onclick="setLang('tr')" title="Türkçe">TR</button>
  <button onclick="setLang('ar')" title="العربية">AR</button>
  <button onclick="setLang('en')" title="English">EN</button>
</div>

<!-- MODAL -->
<div class="modal" id="summaryModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 data-tr="Sipariş Özeti" data-ar="ملخص الطلب" data-en="Order Summary">Sipariş Özeti</h2>
      <button class="close-modal" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body" id="summaryBody"></div>
    <div class="modal-footer">
      <button class="save-btn" onclick="saveOrder()" data-tr="Siparişi Kaydet" data-ar="حفظ الطلب" data-en="Save Order">Siparişi Kaydet</button>
      <button class="wp-btn" onclick="shareWhatsApp()" data-tr="WhatsApp" data-ar="واتساب" data-en="WhatsApp">WhatsApp</button>
      <button class="excel-btn" onclick="downloadExcel()" data-tr="Excel" data-ar="إكسل" data-en="Excel">Excel</button>
    </div>
  </div>
</div>

<script>
  const KOLI_KG = 6;
  let currentLang = localStorage.getItem('lang') || 'tr';
  let currentOrder = {};
  let orders = JSON.parse(localStorage.getItem('orders') || '[]');
  let orderCounter = parseInt(localStorage.getItem('orderCounter') || '1000');

  /* DİL */
  function setLang(lang) {
    currentLang = lang;
    localStorage.setItem('lang', lang);
    document.documentElement.lang = lang;
    document.documentElement.dir = (lang === 'ar' ? 'rtl' : 'ltr');
    document.querySelectorAll('[data-tr]').forEach(el => el.textContent = el.dataset[lang] || el.dataset.tr);
    document.querySelectorAll('.lang-float button').forEach(b => b.classList.toggle('active', b.title.includes(lang === 'ar' ? 'العربية' : lang === 'en' ? 'English' : 'Türkçe')));
    renderProducts(); // başlıkları güncelle
    updateGramTotals();
  }

  /* ÜRÜN VERİSİ */
  const products = [
    {id:1, tr:'Çikolatalı Gofret', ar:'كوفريت بالشوكولاتة', en:'Chocolate Wafer', img:'https://via.placeholder.com/220x110?text=Gofret'},
    {id:2, tr:'Süt 1 L',           ar:'حليب ١ لتر',         en:'Milk 1 L',         img:'https://via.placeholder.com/220x110?text=Süt'},
    {id:3, tr:'Yumurta 6\'lı',     ar:'بيض ٦ قطع',          en:'Eggs 6 pcs',       img:'https://via.placeholder.com/220x110?text=Yumurta'}
  ];

  /* SAYFA AÇILIRKEN */
  window.onload = () => {
    setLang(currentLang);
    document.getElementById('customerName').textContent = localStorage.getItem('currentUser') || '---';
    generateOrderCode();
    renderProducts();
    updateGramTotals();
    updateTotal();
  };

  /* OTO SİPARİŞ KODU */
  function generateOrderCode() {
    const user = localStorage.getItem('currentUser') || '';
    const code = user.toUpperCase() + '-' + (++orderCounter).toString().padStart(4, '0');
    localStorage.setItem('orderCounter', orderCounter);
    document.getElementById('orderCode').value = code;
    document.getElementById('orderCode').placeholder = code;
  }

  /* ÜRÜN KARTLARI */
  function renderProducts() {
    const container = document.getElementById('products');
    container.innerHTML = '';
    products.forEach(p => {
      const card = document.createElement('div');
      card.className = 'card';
      card.innerHTML = `
        <img src="${p.img}" alt="${p[currentLang]||p.tr}">
        <div class="card-header" data-tr="${p.tr}" data-ar="${p.ar}" data-en="${p.en}">${p.tr}</div>
        <table>
          <thead><tr><th data-tr="Gram" data-ar="غرام" data-en="Gram">Gram</th><th data-tr="Koli" data-ar="كولا" data-en="Carton">Koli</th><th data-tr="KG" data-ar="كجم" data-en="KG">KG</th></tr></thead>
          <tbody>
            <tr class="tr-50"><td>50 G</td><td><input type="text" maxlength="6" data-g="50" data-id="${p.id}" placeholder=" "></td><td class="kg" data-g="50"> </td></tr>
            <tr class="tr-250"><td>250 G</td><td><input type="text" maxlength="6" data-g="250" data-id="${p.id}" placeholder=" "></td><td class="kg" data-g="250"> </td></tr>
            <tr class="tr-1000"><td>1000 G</td><td><input type="text" maxlength="6" data-g="1000" data-id="${p.id}" placeholder=" "></td><td class="kg" data-g="1000"> </td></tr>
          </tbody>
          <tfoot><tr class="total-row"><td data-tr="Toplam" data-ar="الإجمالي" data-en="Total">Toplam</td><td data-total-koli="0"> </td><td data-total-kg="0"> </td></tr></tfoot>
        </table>
      `;
      container.appendChild(card);
    });
    container.addEventListener('input', e => {
      if (e.target.dataset.g) {
        const raw = e.target.value.replace(/[^\d]/g, '');
        if (raw.length > 5) { e.target.value = e.target.value.slice(0, 5); return; }
        const koli = Number(raw) || 0;
        const kg = koli * KOLI_KG;
        const kgEl = e.target.closest('tr').querySelector('.kg');
        kgEl.textContent = kg === 0 ? ' ' : Number(kg).toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
        updateCardTotal(e.target.closest('table'));
        updateGramTotals();
        updateTotal();
      }
    });
  }

  /* KART TOPLAMI */
  function updateCardTotal(table) {
    let koli = 0;
    table.querySelectorAll('input[data-g]').forEach(inp => koli += Number(inp.value.replace(/[^\d]/g, '')) || 0);
    const kg = koli * KOLI_KG;
    table.querySelector('[data-total-koli]').textContent = koli === 0 ? ' ' : koli.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
    table.querySelector('[data-total-kg]').textContent = kg === 0 ? ' ' : kg.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
  }

  /* GRAMAJ TOPLAMLARI */
  function updateGramTotals() {
    const totals = { 50: 0, 250: 0, 1000: 0 };
    document.querySelectorAll('input[data-g]').forEach(inp => {
      const g = inp.dataset.g;
      totals[g] += Number(inp.value.replace(/[^\d]/g, '')) || 0;
    });
    const container = document.getElementById('gramTotals');
    container.innerHTML = `
      <div class="gram-card g-50"><div>50 G</div><div class="val">${totals[50] === 0 ? ' ' : totals[50].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} Koli</div><div>${(totals[50] * KOLI_KG) === 0 ? ' ' : (totals[50] * KOLI_KG).toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} KG</div></div>
      <div class="gram-card g-250"><div>250 G</div><div class="val">${totals[250] === 0 ? ' ' : totals[250].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} Koli</div><div>${(totals[250] * KOLI_KG) === 0 ? ' ' : (totals[250] * KOLI_KG).toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} KG</div></div>
      <div class="gram-card g-1000"><div>1000 G</div><div class="val">${totals[1000] === 0 ? ' ' : totals[1000].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} Koli</div><div>${(totals[1000] * KOLI_KG) === 0 ? ' ' : (totals[1000] * KOLI_KG).toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} KG</div></div>
    `;
  }

  /* GENEL TOPLAM */
  function updateTotal() {
    const totals = { 50: 0, 250: 0, 1000: 0 };
    document.querySelectorAll('input[data-g]').forEach(inp => {
      totals[inp.dataset.g] += Number(inp.value.replace(/[^\d]/g, '')) || 0;
    });
    const totalKoli = totals[50] + totals[250] + totals[1000];
    const totalKg = totalKoli * KOLI_KG;
    document.getElementById('totalKoli').textContent = totalKoli === 0 ? ' ' : totalKoli.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
    document.getElementById('totalKg').textContent = totalKg === 0 ? ' ' : totalKg.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
  }

  /* YENİ SİPARİŞ */
  function yeniSiparis() {
    document.getElementById('customer').value = '';
    document.querySelectorAll('input[data-g]').forEach(inp => inp.value = '');
    document.querySelectorAll('.kg').forEach(td => td.textContent = ' ');
    document.querySelectorAll('[data-total-koli]').forEach(td => td.textContent = ' ');
    document.querySelectorAll('[data-total-kg]').forEach(td => td.textContent = ' ');
    updateGramTotals();
    updateTotal();
    generateOrderCode();
  }

  /* MODAL AÇ/KAPAT */
  function showSummary() {
    const customer = document.getElementById('customer').value.trim();
    if (!customer) { alert(currentLang === 'ar' ? 'يرجى إدخال اسم العميل' : currentLang === 'en' ? 'Please enter customer name' : 'Lütfen müşteri adı girin'); return; }
    const code = document.getElementById('orderCode').value.trim();
    const ship = document.querySelector('input[name="ship"]:checked').value;
    const shipText = { road: currentLang === 'ar' ? 'الطريق البري' : currentLang === 'en' ? 'Road' : 'Karayolu', sea: currentLang === 'ar' ? 'البحرية' : currentLang === 'en' ? 'Sea' : 'Denizyolu', air: currentLang === 'ar' ? 'الجوية' : currentLang === 'en' ? 'Air' : 'Havayolu' }[ship];
    const totals = { 50: 0, 250: 0, 1000: 0, koli: 0, kg: 0 };
    const items = [];
    document.querySelectorAll('.card').forEach(card => {
      const name = card.querySelector('.card-header').dataset[currentLang] || card.querySelector('.card-header').dataset.tr;
      const vals = { 50: 0, 250: 0, 1000: 0 };
      let cardKoli = 0;
      card.querySelectorAll('input[data-g]').forEach(inp => {
        const g = inp.dataset.g;
        const koli = Number(inp.value.replace(/[^\d]/g, '')) || 0;
        vals[g] = koli;
        cardKoli += koli;
        totals[g] += koli;
      });
      totals.koli += cardKoli;
      totals.kg += cardKoli * KOLI_KG;
      if (cardKoli > 0) items.push({ name, ...vals, koli: cardKoli, kg: cardKoli * KOLI_KG });
    });
    currentOrder = { customer, code, ship: shipText, items, totals, date: new Date().toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR') };

    const body = document.getElementById('summaryBody');
    body.innerHTML = `
      <p><strong data-tr="Müşteri" data-ar="العميل" data-en="Customer">Müşteri:</strong> ${customer}</p>
      <p><strong data-tr="Sipariş Kodu" data-ar="رمز الطلب" data-en="Order Code">Sipariş Kodu:</strong> ${code}</p>
      <p><strong data-tr="Gönderim" data-ar="الشحن" data-en="Shipping">Gönderim:</strong> ${shipText}</p>
      <p><strong data-tr="Tarih" data-ar="التاريخ" data-en="Date">Tarih:</strong> ${currentOrder.date}</p>
      <hr style="margin:10px 0;border:none;border-top:1px solid var(--border)">
      <table style="width:100%;font-size:.85rem">
        <thead><tr><th data-tr="Ürün" data-ar="المنتج" data-en="Product">Ürün</th><th>50 G</th><th>250 G</th><th>1000 G</th><th data-tr="Toplam" data-ar="الإجمالي" data-en="Total">Toplam</th></tr></thead>
        <tbody>
          ${items.map(it => `<tr><td>${it.name}</td><td>${it[50] === 0 ? ' ' : it[50].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')}</td><td>${it[250] === 0 ? ' ' : it[250].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')}</td><td>${it[1000] === 0 ? ' ' : it[1000].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')}</td><td>${it.koli.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} Koli / ${it.kg.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} KG</td></tr>`).join('')}
        </tbody>
      </table>
      <hr style="margin:10px 0;border:none;border-top:1px solid var(--border)">
      <p style="font-weight:700;color:var(--gold)"><span data-tr="Genel Toplam" data-ar="الإجمالي الكلي" data-en="Grand Total">Genel Toplam</span>: ${totals.koli.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} Koli / ${totals.kg.toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR')} KG</p>
    `;
    document.getElementById('summaryModal').classList.add('show');
  }
  function closeModal() { document.getElementById('summaryModal').classList.remove('show'); }

  /* KAYDET */
  function saveOrder() {
    orders.push(currentOrder);
    localStorage.setItem('orders', JSON.stringify(orders));
    closeModal();
    alert(currentLang === 'ar' ? '✅ تم الحفظ' : currentLang === 'en' ? '✅ Saved' : '✅ Kaydedildi');
    yeniSiparis();
  }

  /* WHATSAPP */
  function shareWhatsApp() {
    if (!currentOrder) return;
    let txt = `*SİPARİŞ ÖZETİ*\n\n*Müşteri:* ${currentOrder.customer}\n*Kod:* ${currentOrder.code}\n*Gönderim:* ${currentOrder.ship}\n*Tarih:* ${currentOrder.date}\n\n`;
    currentOrder.items.forEach(it => {
      txt += `• ${it.name}\n  50G: ${it[50] || 0}  |  250G: ${it[250] || 0}  |  1000G: ${it[1000] || 0}\n  Toplam: ${it.koli} Koli / ${it.kg} KG\n\n`;
    });
    txt += `*Genel Toplam:* ${currentOrder.totals.koli} Koli / ${currentOrder.totals.kg} KG`;
    window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
  }

  /* EXCEL */
  function downloadExcel() {
    if (!currentOrder) return;
    const wb = XLSX.utils.book_new();
    const title = [
      ["SİPARİŞ ÖZETİ"],
      [],
      ["Müşteri", currentOrder.customer],
      ["Kod", currentOrder.code],
      ["Gönderim", currentOrder.ship],
      ["Tarih", currentOrder.date],
      []
    ];
    const headers = [["Ürün", "50 G", "250 G", "1000 G", "Toplam Koli", "Toplam KG"]];
    const data = currentOrder.items.map(it => [
      it.name,
      it[50] || 0,
      it[250] || 0,
      it[1000] || 0,
      it.koli,
      it.kg
    ]);
    const totals = [["GENEL TOPLAM", currentOrder.totals[50], currentOrder.totals[250], currentOrder.totals[1000], currentOrder.totals.koli, currentOrder.totals.kg]];
    const allData = [...title, ...headers, ...data, ...totals];
    const ws = XLSX.utils.aoa_to_sheet(allData);
    XLSX.utils.book_append_sheet(wb, ws, "Sipariş");
    XLSX.writeFile(wb, `Sipariş_${currentOrder.code}.xlsx`);
  }

  /* KAYITLI SİPARİŞLER */
  function kayitliSiparisler() {
    if (orders.length === 0) { alert(currentLang === 'ar' ? 'لا توجد طلبات مسجلة' : currentLang === 'en' ? 'No saved orders' : 'Kayıtlı sipariş yok'); return; }
    let msg = currentLang === 'ar' ? 'اختر طلبًا للتحرير:\n\n' : currentLang === 'en' ? 'Choose an order to edit:\n\n' : 'Düzenlemek için sipariş seçin:\n\n';
    orders.forEach((o, i) => { msg += `${i + 1}. ${o.customer} - ${o.code} (${o.totals.koli} Koli)\n`; });
    const idx = prompt(msg);
    if (!idx || isNaN(idx) || idx < 1 || idx > orders.length) return;
    const order = orders[Number(idx) - 1];
    loadOrder(order);
  }
  function loadOrder(order) {
    document.getElementById('customer').value = order.customer;
    document.getElementById('orderCode').value = order.code;
    const shipMap = { Karayolu: 'road', 'الطريق البري': 'road', Road: 'road', Denizyolu: 'sea', البحرية: 'sea', Sea: 'sea', Havayolu: 'air', الجوية: 'air', Air: 'air' };
    document.querySelector(`input[name="ship"][value="${shipMap[order.ship]}"]`).checked = true;
    // ürünleri yükle
    document.querySelectorAll('.card').forEach(card => {
      const name = card.querySelector('.card-header').dataset.tr;
      const item = order.items.find(it => it.name === name);
      if (item) {
        card.querySelector('input[data-g="50"]').value = item[50] === 0 ? '' : item[50].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
        card.querySelector('input[data-g="250"]').value = item[250] === 0 ? '' : item[250].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
        card.querySelector('input[data-g="1000"]').value = item[1000] === 0 ? '' : item[1000].toLocaleString(currentLang === 'ar' ? 'ar-IQ' : 'tr-TR');
        updateCardTotal(card.querySelector('table'));
      }
    });
    updateGramTotals();
    updateTotal();
  }

  /* XLsx kütüphanesi CDN */
  const script = document.createElement('script');
  script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
  document.head.appendChild(script);
</script>

</body>
</html>
