<!DOCTYPE html>
<html lang="tr" dir="ltr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Adalya Company ‚Äì Anasayfa</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <link rel="icon" href="data:,">
  <style>
    :root{--gold:#d4af37;--bg:#f5f7fa;--surface:#fff;--text:#2c3e50;--error:#e74c3c;--border:#e0e0e0;--g50:#e8f5e9;--g250:#ffebee;--g1000:#e3f2fd;--total:#fff9c4;--radius:16px;--shadow:0 8px 30px rgba(0,0,0,.08);}
    *{box-sizing:border-box;margin:0;padding:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif}
    body{background:var(--bg);color:var(--text)}
    .top-bar{display:flex;align-items:center;justify-content:space-between;padding:16px;background:var(--surface);box-shadow:var(--shadow);position:sticky;top:0;z-index:990}
    .logo-name{display:flex;align-items:center;gap:12px}
    .logo-name img{height:48px;border-radius:12px}
    .logo-name .company{font-size:1.2rem;font-weight:700;letter-spacing:.5px}
    .top-right{display:flex;align-items:center;gap:12px}
    .user-info{font-size:.9rem;font-weight:600}
    .logout-btn{background:var(--error);color:#fff;border:none;border-radius:var(--radius);padding:10px 16px;font-size:.85rem;font-weight:600;cursor:pointer;transition:background .2s}
    .logout-btn:hover{background:#c0392b}
    .lang-group{display:flex;gap:6px;background:rgba(255,255,255,.85);backdrop-filter:blur(6px);padding:6px;border-radius:30px;box-shadow:0 4px 18px rgba(0,0,0,.15)}
    .lang-group button{min-width:64px;height:40px;border:none;border-radius:20px;font-size:.9rem;font-weight:700;cursor:pointer;background:#fff;color:var(--text);transition:transform .2s}
    .lang-group button:active{transform:scale(.92)}
    .lang-group button.active{background:var(--gold);color:#fff}
    .content{padding:16px;max-width:1600px;margin:auto}
    .order-header{background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow);padding:16px;margin-bottom:16px;text-align:center}
    .order-code{font-size:1.5rem;font-weight:700;color:var(--gold);letter-spacing:1px}
    .gonderim-buttons{display:flex;gap:12px;justify-content:center;margin-bottom:16px}
    .gonderim-btn{flex:1;padding:12px;border:none;border-radius:var(--radius);font-size:1rem;font-weight:600;cursor:pointer;transition:all .3s ease;background:#eee;color:var(--text)}
    .gonderim-btn.active{background:var(--gold);color:#fff;transform:scale(1.05)}
    .gonderim-btn span{font-size:1.4rem;margin-right:6px}
    .search-box{position:relative;max-width:600px;margin:0 auto 24px}
    .search-input{width:100%;padding:14px 48px 14px 16px;border:2px solid var(--border);border-radius:var(--radius);font-size:1.1rem;transition:border-color .2s}
    .search-input:focus{border-color:var(--gold);outline:none}
    .clear-search{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;font-size:1.4rem;color:var(--text);cursor:pointer;padding:4px}
    .products-container{display:grid;gap:12px;max-width:1600px;margin:0 auto;grid-template-columns:repeat(5, 1fr);}
    @media (max-width: 1400px){.products-container{grid-template-columns:repeat(4, 1fr);}}
    @media (max-width: 1100px){.products-container{grid-template-columns:repeat(3, 1fr);}}
    @media (max-width: 800px){.products-container{grid-template-columns:repeat(2, 1fr);}}
    @media (max-width: 500px){.products-container{grid-template-columns:1fr;}}
    .product-card{border-radius:var(--radius);overflow:hidden;background:var(--surface);box-shadow:var(--shadow);transition:transform .3s ease, box-shadow .3s ease;will-change:transform;opacity:0;transform:translateY(20px)}
    .product-card.visible{opacity:1;transform:translateY(0)}
    .product-card:hover{transform:translateY(-5px);box-shadow:0 12px 35px rgba(0,0,0,.15)}
    .product-img-box{width:100%;height:120px;display:flex;align-items:center;justify-content:center;background:#f5f7fa;border-top-left-radius:var(--radius);border-top-right-radius:var(--radius);overflow:hidden}
    .product-img{max-width:100%;max-height:100%;object-fit:contain;border-radius:8px}
    .product-name{background:linear-gradient(135deg, var(--gold), #f1c40f);color:#fff;padding:8px 6px;text-align:center;font-weight:700;font-size:0.9rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .product-table{width:100%;border-collapse:collapse;font-size:0.85rem;table-layout:fixed}
    .product-table th,.product-table td{width:33.33%;padding:6px 4px;text-align:center;border:1px solid var(--border);height:32px}
    .product-table th{background:#f8f9fa;font-weight:700;color:var(--text)}
    .product-table tbody tr.gram-50{background:var(--g50)}
    .product-table tbody tr.gram-250{background:var(--g250)}
    .product-table tbody tr.gram-1000{background:var(--g1000)}
    .product-table tfoot td{background:var(--total);font-weight:700;color:var(--text)}
    .koli-input input{width:100%;padding:6px 4px;border:1.4px solid var(--border);border-radius:6px;font-family:'Courier New', monospace;font-size:0.85rem;font-weight:600;text-align:center;direction:ltr;transition:border-color .2s}
    .koli-input input:focus{border-color:var(--gold);outline:none}
    .action-buttons{display:flex;gap:12px;margin:24px 0;justify-content:center}
    .btn-modern{display:inline-flex;align-items:center;gap:8px;padding:12px 20px;border:none;border-radius:var(--radius);font-size:1rem;font-weight:600;cursor:pointer;transition:transform .2s}
    .btn-modern:active{transform:scale(.96)}
    .btn-primary{background:var(--gold);color:#fff;box-shadow:0 2px 8px rgba(212,175,55,.3)}
    .btn-secondary{background:#eee;color:var(--text)}
    .excel-btn{background:#217346;color:#fff}
    .bottom-total{position:fixed;bottom:0;left:0;right:0;background:rgba(255,255,255,.95);backdrop-filter:blur(6px);border-top:2px solid var(--gold);padding:12px 16px;z-index:1000;display:flex;align-items:center;justify-content:space-between;font-size:1rem;font-weight:600;box-shadow:0 -4px 20px rgba(0,0,0,.1)}
    .bottom-total .label{color:var(--gold);}
    .bottom-total .val{font-family:'Courier New', monospace;}
    .gram-totals{font-size:.8rem;display:flex;gap:12px}
    .modal{display:none;position:fixed;inset:0;z-index:2000;background:rgba(0,0,0,.45);align-items:center;justify-content:center;padding:16px}
    .modal.show{display:flex}
    .modal-content{background:var(--surface);border-radius:var(--radius);width:100%;max-width:700px;max-height:90vh;overflow-y:auto;box-shadow:0 8px 30px rgba(0,0,0,.2);display:flex;flex-direction:column}
    .modal-header{display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid var(--border)}
    .modal-header h2{font-size:1.2rem;font-weight:700}
    .close-modal{background:none;border:none;font-size:1.4rem;cursor:pointer;color:var(--text)}
    .modal-body{padding:16px;font-size:.85rem;line-height:1.5;display:flex;flex-direction:column;gap:10px}
    .modal-footer{display:flex;gap:8px;padding:12px 16px;border-top:1px solid var(--border)}
    .modal-footer button{flex:1;padding:10px;border:none;border-radius:var(--radius);font-size:.85rem;font-weight:600;cursor:pointer}
    .save-btn{background:var(--gold);color:#fff}
    .btn-secondary{background:#eee;color:var(--text)}
  </style>
</head>
<body>

<header class="top-bar">
  <div class="logo-name"><img src="img/adalyalogo.jpg" alt="Logo"><span class="company" data-tr="Adalya Company" data-ar="ÿ¥ÿ±ŸÉÿ© ÿ£ÿØÿßŸÑŸäÿß" data-en="Adalya Company">Adalya Company</span></div>
  <div class="top-right">
    <div class="lang-group">
      <button class="active" onclick="setLang('tr')" title="T√ºrk√ße">TR</button>
      <button onclick="setLang('ar')" title="ÿßŸÑÿπÿ±ÿ®Ÿäÿ©">AR</button>
      <button onclick="setLang('en')" title="English">EN</button>
    </div>
    <span class="user-info" id="userName"></span>
    <button class="logout-btn" onclick="cikis()">√áƒ±kƒ±≈ü</button>
  </div>
</header>

<div class="content">
  <div class="order-header">
    <div class="order-code" id="orderCode">ADL000</div>
    <div data-tr="Sipari≈ü Kodu" data-ar="ŸÉŸàÿØ ÿßŸÑÿ∑ŸÑÿ®" data-en="Order Code">Sipari≈ü Kodu</div>
  </div>

  <div class="gonderim-buttons">
    <button class="gonderim-btn active" data-value="Karayolu" onclick="setGonderim('Karayolu')" data-tr="Karayolu" data-ar="ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ÿ±Ÿä" data-en="Road"><span>üöõ</span><span>Karayolu</span></button>
    <button class="gonderim-btn" data-value="Denizyolu" onclick="setGonderim('Denizyolu')" data-tr="Denizyolu" data-ar="ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ÿ≠ÿ±Ÿä" data-en="Sea"><span>üö¢</span><span>Denizyolu</span></button>
    <button class="gonderim-btn" data-value="Havayolu" onclick="setGonderim('Havayolu')" data-tr="Havayolu" data-ar="ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ¨ŸàŸä" data-en="Air"><span>‚úàÔ∏è</span><span>Havayolu</span></button>
  </div>

  <section id="products" class="section active">
    <div class="search-box">
      <input id="prodSearch" class="search-input" placeholder="√úr√ºn ara (TR/AR/EN)" oninput="filterProducts()">
      <button class="clear-search" onclick="clearSearch()" title="Temizle">√ó</button>
    </div>
    <div class="products-container" id="productsList"></div>
  </section>

  <div class="action-buttons">
    <button class="btn-modern btn-secondary" onclick="newOrder()" data-tr="Yeni Sipari≈ü" data-ar="ÿ∑ŸÑÿ® ÿ¨ÿØŸäÿØ" data-en="New Order">Yeni Sipari≈ü</button>
    <button class="btn-modern btn-primary" onclick="openOrderModal()" data-tr="Sipari≈ü √ñzeti & Kaydet" data-ar="ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑ŸÑÿ® & ÿ≠ŸÅÿ∏" data-en="Order Summary & Save">Sipari≈ü √ñzeti & Kaydet</button>
    <button class="btn-modern btn-secondary" onclick="openMyOrders()" data-tr="Sipari≈ülerim" data-ar="ÿ∑ŸÑÿ®ÿßÿ™Ÿä" data-en="My Orders">Sipari≈ülerim</button>
  </div>
</div>

<div class="bottom-total" id="bottomTotal">
  <div>
    <span class="label" data-tr="Genel Toplam" data-ar="ÿßŸÑŸÖÿ¨ŸÖŸàÿπ ÿßŸÑÿπÿßŸÖ" data-en="Grand Total">Genel Toplam</span>
    <span class="val" id="bottomTotalKg">0 kg</span>
  </div>
  <div class="gram-totals">
    <span>50G: <span id="tot50">0</span> kg</span>
    <span>250G: <span id="tot250">0</span> kg</span>
    <span>1000G: <span id="tot1000">0</span> kg</span>
    <span>Koli: <span id="totKoli">0</span></span>
  </div>
</div>

<div class="modal" id="orderModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 data-tr="Sipari≈ü √ñzeti" data-ar="ŸÖŸÑÿÆÿµ ÿßŸÑÿ∑ŸÑÿ®" data-en="Order Summary">Sipari≈ü √ñzeti</h2>
      <button class="close-modal" onclick="closeOrderModal()">&times;</button>
    </div>
    <div class="modal-body" id="orderModalBody"></div>
    <div class="modal-footer">
      <button class="save-btn" onclick="saveOrder()" data-tr="Kaydet" data-ar="ÿ≠ŸÅÿ∏" data-en="Save">Kaydet</button>
      <button class="btn-secondary" onclick="shareOrder()" data-tr="Payla≈ü" data-ar="ŸÖÿ¥ÿßÿ±ŸÉÿ©" data-en="Share">Payla≈ü</button>
      <button class="excel-btn" onclick="downloadExcel()" data-tr="Excel ƒ∞ndir" data-ar="ÿ™ÿ≠ŸÖŸäŸÑ ÿ•ŸÉÿ≥ŸÑ" data-en="Download Excel">Excel ƒ∞ndir</button>
      <button class="btn-secondary" onclick="closeOrderModal()" data-tr="Kapat" data-ar="ÿ•ÿ∫ŸÑÿßŸÇ" data-en="Close">Kapat</button>
    </div>
  </div>
</div>

<script>
  const TOKEN = sessionStorage.getItem('ghToken') || (()=>{ const t=prompt('GitHub Personal Access Token (repo scope):'); if(t) sessionStorage.setItem('ghToken',t); return t; })();
  const REPO   = 'XwinSherin/adalyacompany';
  const BRANCH = 'main';

  async function writeGitHubFile(path, content, message){
    if (!TOKEN) { alert('Token yok'); return; }
    try {
      const getRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`, {
        headers: { 'Authorization': `token ${TOKEN}` }
      });
      let sha = '';
      if (getRes.status === 200) {
        const fileInfo = await getRes.json();
        sha = fileInfo.sha;
      } else if (getRes.status === 404) {
        // yeni dosya
      } else throw new Error('SHA alƒ±namadƒ±');
      const encoded = btoa(unescape(encodeURIComponent(content)));
      const putRes = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}`, {
        method : 'PUT',
        headers: { 'Authorization': `token ${TOKEN}`, 'Content-Type': 'application/json' },
        body   : JSON.stringify({ message, content: encoded, sha })
      });
      if (!putRes.ok) throw new Error((await putRes.json()).message || putRes.statusText);
    } catch (err) {
      console.error(err);
      alert('Yazma hatasƒ±: ' + err.message);
    }
  }

  async function readGitHubFile(path){
    if (!TOKEN) return null;
    try {
      const res = await fetch(`https://api.github.com/repos/${REPO}/contents/${path}?ref=${BRANCH}`, {
        headers: { 'Authorization': `token ${TOKEN}` }
      });
      if (!res.ok) return null;
      const data = await res.json();
      return JSON.parse(atob(data.content));
    } catch (e) {
      console.error(e);
      return null;
    }
  }

  let products   = [];
  let orders     = [];
  let currentOrder = {};
  const KOLI_KG  = 6;
  let gonderim   = 'Karayolu';
  let lang       = localStorage.getItem('lang') || 'tr';

  (()=>{
    if(sessionStorage.getItem('role')!=='user') location.href='index.html';
    document.getElementById('userName').textContent=sessionStorage.getItem('currentUser')||'Bayi';
  })();

  function cikis(){ sessionStorage.clear(); location.href='index.html'; }

  /* ===== NULL-SAFE Dƒ∞L ‚Äì CONSOLE HATASIZ ===== */
  function setLang(l){
    lang=l; localStorage.setItem('lang',lang);
    document.documentElement.lang=lang;
    document.documentElement.dir=(lang==='ar'?'rtl':'ltr');
    document.querySelectorAll('[data-tr]').forEach(el=>{
      if(!el) return;
      el.textContent = el.dataset[lang] || el.dataset.tr;
    });
    document.querySelectorAll('.gonderim-btn').forEach(btn=>{
      const val = btn.dataset.value;
      const trMap={Karayolu:'Karayolu',Denizyolu:'Denizyolu',Havayolu:'Havayolu'};
      const arMap={Karayolu:'ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ÿ±Ÿä',Denizyolu:'ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ®ÿ≠ÿ±Ÿä',Havayolu:'ÿßŸÑÿ∑ÿ±ŸäŸÇ ÿßŸÑÿ¨ŸàŸä'};
      const enMap={Karayolu:'Road',Denizyolu:'Sea',Havayolu:'Air'};
      const map=lang==='ar'?arMap:lang==='en'?enMap:trMap;
      const span = btn.querySelector('span:last-child');
      if(span) span.textContent = map[val];
    });
    document.querySelectorAll('.lang-group button').forEach(b=>
      b.classList.toggle('active',b.title.includes(lang==='ar'?'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©':lang==='en'?'English':'T√ºrk√ße'))
    );
  }

  async function loadProducts(){
    products = await readGitHubFile('products.json') || [];
    products = products.filter(p => p.active !== false);
    renderProducts();
    generateOrderCode();
    setInterval(updateBottomTotal,300);
  }

  async function loadOrders(){
    orders = await readGitHubFile('orders.json') || [];
  }

  function generateOrderCode(){
    const user=sessionStorage.getItem('currentUser')||'ADL';
    const today=new Date();
    const dateStr=String(today.getDate()).padStart(2,'0')+String(today.getMonth()+1).padStart(2,'0')+String(today.getFullYear()).slice(-2);
    const lastOrder=orders.length?orders[orders.length-1]:{code:user+dateStr+'000'};
    const lastNum=parseInt(lastOrder.code.slice(-3),10);
    const newNum=String(lastNum+1).padStart(3,'0');
    document.getElementById('orderCode').textContent=user+dateStr+newNum;
  }

  function setGonderim(val){
    gonderim=val;
    document.querySelectorAll('.gonderim-btn').forEach(b=>b.classList.remove('active'));
    document.querySelector(`[data-value="${val}"]`).classList.add('active');
  }

  function newOrder(){
    document.querySelectorAll('.koli-input input').forEach(inp=>inp.value='');
    document.querySelectorAll('.kg-display').forEach(td=>td.textContent='');
    document.querySelectorAll('.total-koli').forEach(td=>td.textContent='');
    document.querySelectorAll('.total-kg').forEach(td=>td.textContent='');
    generateOrderCode();
    updateBottomTotal();
  }

  function fmt(n){return n.toLocaleString(lang==='ar'?'ar-SA':'tr-TR');}

  function updateKg(inp,gr,idx){
    const val=Math.max(0,parseInt(inp.value)||0);
    const kg=val*KOLI_KG;
    const card=inp.closest('.product-card');
    card.querySelector(`.kg-${gr}`).textContent=fmt(kg);
    const k50=parseInt(card.querySelector('.kg-50').textContent.replace(/\s/g,'')||0);
    const k250=parseInt(card.querySelector('.kg-250').textContent.replace(/\s/g,'')||0);
    const k1000=parseInt(card.querySelector('.kg-1000').textContent.replace(/\s/g,'')||0);
    const totKg=k50+k250+k1000;
    const totKoli=totKg/KOLI_KG;
    card.querySelector('.total-koli').textContent=fmt(totKoli);
    card.querySelector('.total-kg').textContent=fmt(totKg);
    updateBottomTotal();
  }

  function updateBottomTotal(){
    let t50=0,t250=0,t1000=0;
    document.querySelectorAll('.product-card').forEach(card=>{
      t50+=parseInt(card.querySelector('.kg-50').textContent.replace(/\s/g,'')||0);
      t250+=parseInt(card.querySelector('.kg-250').textContent.replace(/\s/g,'')||0);
      t1000+=parseInt(card.querySelector('.kg-1000').textContent.replace(/\s/g,'')||0);
    });
    const tot=t50+t250+t1000;
    document.getElementById('bottomTotalKg').textContent=fmt(tot)+' kg';
    document.getElementById('tot50').textContent=fmt(t50);
    document.getElementById('tot250').textContent=fmt(t250);
    document.getElementById('tot1000').textContent=fmt(t1000);
    document.getElementById('totKoli').textContent=fmt(tot/KOLI_KG);
  }

  function clearSearch(){document.getElementById('prodSearch').value='';filterProducts();}
  function filterProducts(){renderProducts();}

  function renderProducts(){
    const list=document.getElementById('productsList');
    list.innerHTML='';
    const search=document.getElementById('prodSearch').value.toLowerCase();
    const filtered=products.filter(p=>
      p.tr.toLowerCase().includes(search)||
      p.ar.toLowerCase().includes(search)||
      p.en.toLowerCase().includes(search)
    );
    filtered.forEach((p,i)=>{
      const card=document.createElement('div');
      card.className='product-card';
      const name=lang==='ar'?p.ar:lang==='en'?p.en:p.tr;
      card.innerHTML=`
        <div class="product-img-box"><img class="product-img" src="https://raw.githubusercontent.com/XwinSherin/adalyacompany/main/${p.img}" alt="${name}" onerror="this.src='https://via.placeholder.com/300x120?text=PNG'"></div>
        <div class="product-name" data-tr="${p.tr}" data-ar="${p.ar}" data-en="${p.en}">${name}</div>
        <table class="product-table">
          <thead><tr><th>Gramaj</th><th>Koli</th><th>Kg</th></tr></thead>
          <tbody>
            <tr class="gram-50"><td>50G</td><td class="koli-input"><input type="text" maxlength="5" placeholder="" oninput="formatKoli(this,50,${i})"></td><td class="kg-50 kg-display"></td></tr>
            <tr class="gram-250"><td>250G</td><td class="koli-input"><input type="text" maxlength="5" placeholder="" oninput="formatKoli(this,250,${i})"></td><td class="kg-250 kg-display"></td></tr>
            <tr class="gram-1000"><td>1000G</td><td class="koli-input"><input type="text" maxlength="5" placeholder="" oninput="formatKoli(this,1000,${i})"></td><td class="kg-1000 kg-display"></td></tr>
          </tbody>
          <tfoot><tr><td>Toplam</td><td class="total-koli"></td><td class="total-kg"></td></tr></tfoot>
        </table>
      `;
      list.appendChild(card);
      setTimeout(()=>card.classList.add('visible'),i*50);
    });
  }

  /* ===== KOLƒ∞ Gƒ∞Rƒ∞≈û ‚Äì SADECE SAYI, MAX 5, Bƒ∞NLƒ∞K AYIRAC ‚Äì MAD-1 / MAD-2 ===== */
  function formatKoli(inp,gr,idx){
    let v=inp.value.replace(/[^0-9]/g,'').slice(0,5);
    if(v===''){v='0';}
    const num=parseInt(v,10);
    inp.value=fmt(num);
    updateKg(inp,gr,idx);
  }

  function openOrderModal(){
    const code=document.getElementById('orderCode').textContent;
    const body=document.getElementById('orderModalBody');
    body.innerHTML=`
      <p><strong>Sipari≈ü Kodu:</strong> ${code}</p>
      <p><strong>G√∂nderim:</strong> ${gonderim}</p>
      <table class="product-table">
        <thead><tr><th>√úr√ºn</th><th>Gramaj</th><th>Koli</th><th>Kg</th></tr></thead>
        <tbody id="orderModalTable"></tbody>
      </table>
      <div class="toplamlar">
        <p><strong>Toplam 50G:</strong> <span id="modal50"></span> kg</p>
        <p><strong>Toplam 250G:</strong> <span id="modal250"></span> kg</p>
        <p><strong>Toplam 1000G:</strong> <span id="modal1000"></span> kg</p>
        <p><strong>Genel Toplam:</strong> <span id="modalTotal"></span> kg</p>
      </div>
    `;
    let m50=0,m250=0,m1000=0;
    document.querySelectorAll('.product-card').forEach(card=>{
      const k50=parseInt(card.querySelector('.kg-50').textContent.replace(/\s/g,'')||0);
      const k250=parseInt(card.querySelector('.kg-250').textContent.replace(/\s/g,'')||0);
      const k1000=parseInt(card.querySelector('.kg-1000').textContent.replace(/\s/g,'')||0);
      const name=card.querySelector('.product-name').textContent;
      if(k50>0)  document.getElementById('orderModalTable').innerHTML+=`<tr class="gram-50"><td>${name}</td><td>50G</td><td>${fmt(k50/6)}</td><td>${fmt(k50)}</td></tr>`;
      if(k250>0) document.getElementById('orderModalTable').innerHTML+=`<tr class="gram-250"><td>${name}</td><td>250G</td><td>${fmt(k250/6)}</td><td>${fmt(k250)}</td></tr>`;
      if(k1000>0)document.getElementById('orderModalTable').innerHTML+=`<tr class="gram-1000"><td>${name}</td><td>1000G</td><td>${fmt(k1000/6)}</td><td>${fmt(k1000)}</td></tr>`;
      m50+=k50;m250+=k250;m1000+=k1000;
    });
    document.getElementById('modal50').textContent=fmt(m50);
    document.getElementById('modal250').textContent=fmt(m250);
    document.getElementById('modal1000').textContent=fmt(m1000);
    document.getElementById('modalTotal').textContent=fmt(m50+m250+m1000);
    document.getElementById('orderModal').classList.add('show');
  }
  function closeOrderModal(){document.getElementById('orderModal').classList.remove('show');}

  async function saveOrder(){
    const code=document.getElementById('orderCode').textContent;
    const items=[];
    document.querySelectorAll('.product-card').forEach(card=>{
      const k50=parseInt(card.querySelector('.kg-50').textContent.replace(/\s/g,'')||0);
      const k250=parseInt(card.querySelector('.kg-250').textContent.replace(/\s/g,'')||0);
      const k1000=parseInt(card.querySelector('.kg-1000').textContent.replace(/\s/g,'')||0);
      const name=card.querySelector('.product-name').dataset.tr;
      if(k50+k250+k1000===0) return;
      items.push({
        product:name,
        50:k50/6,
        250:k250/6,
        1000:k1000/6,
        koli:(k50+k250+k1000)/6,
        kg:k50+k250+k1000
      });
    });
    if(items.length===0){alert('En az bir √ºr√ºn girin!');return;}
    const order={
      user:sessionStorage.getItem('currentUser')||'Bayi',
      code:code,
      gonderim:gonderim,
      date:new Date().toISOString(),
      items:items,
      totalKg:items.reduce((a,b)=>a+b.kg,0),
      totalKoli:items.reduce((a,b)=>a+b.koli,0),
      status:'pending'
    };
    orders.push(order);
    await writeGitHubFile('orders.json',JSON.stringify(orders,null,2),`Sipari≈ü eklendi: ${code}`);
    closeOrderModal();
    newOrder();
  }

  function downloadExcel(){
    const code=document.getElementById('orderCode').textContent;
    const wb=XLSX.utils.book_new();
    const wsData=[['√úr√ºn','Gramaj','Koli','Kg']];
    document.querySelectorAll('.product-card').forEach(card=>{
      const k50=parseInt(card.querySelector('.kg-50').textContent.replace(/\s/g,'')||0);
      const k250=parseInt(card.querySelector('.kg-250').textContent.replace(/\s/g,'')||0);
      const k1000=parseInt(card.querySelector('.kg-1000').textContent.replace(/\s/g,'')||0);
      const name=card.querySelector('.product-name').dataset.tr;
      if(k50>0)  wsData.push([name,'50G',k50/6,k50]);
      if(k250>0) wsData.push([name,'250G',k250/6,k250]);
      if(k1000>0)wsData.push([name,'1000G',k1000/6,k1000]);
    });
    const ws=XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb,ws,'Sipari≈ü');
    XLSX.writeFile(wb,`${code}.xlsx`);
  }

  function shareOrder(){
    const code=document.getElementById('orderCode').textContent;
    const tot=document.getElementById('bottomTotalKg').textContent;
    const text=`Sipari≈ü Kodum: ${code}\nG√∂nderim: ${gonderim}\nToplam: ${tot}`;
    const url=`https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url,'_blank');
  }

  async function openMyOrders(){
    await loadOrders();
    const my=orders.filter(o=>o.user===(sessionStorage.getItem('currentUser')||'Bayi'));
    const body=document.getElementById('orderModalBody');
    body.innerHTML='';
    if(my.length===0){body.innerHTML='<p>Hen√ºz sipari≈üiniz yok.</p>';}
    else {
      my.forEach(o=>{
        body.innerHTML+=`
          <div style="border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:12px;">
            <p><strong>${o.code}</strong> ‚Äì ${o.gonderim} ‚Äì ${new Date(o.date).toLocaleString('tr-TR')}</p>
            <p>Toplam: ${fmt(o.totalKg)} kg ‚Äì Koli: ${fmt(o.totalKoli)}</p>
            <div style="display:flex;gap:6px;margin-top:8px;">
              <button class="btn-small btn-detail" onclick="viewOrder('${o.code}')">G√∂r</button>
              <button class="btn-small btn-secondary" onclick="shareOrderFrom('${o.code}')">Payla≈ü</button>
              <button class="btn-small btn-reject" onclick="deleteOrder('${o.code}')">Sil</button>
            </div>
          </div>
        `;
      });
    }
    document.getElementById('orderModal').classList.add('show');
  }
  async function viewOrder(code){
    await loadOrders();
    const o=orders.find(x=>x.code===code);
    if(!o)return;
    const body=document.getElementById('orderModalBody');
    body.innerHTML=`
      <p><strong>${o.code}</strong> ‚Äì ${o.gonderim}</p>
      <table class="product-table">
        <thead><tr><th>√úr√ºn</th><th>Gramaj</th><th>Koli</th><th>Kg</th></tr></thead>
        <tbody>${o.items.map(it=>`<tr class="gram-${it.gram}"><td>${it.product}</td><td>${it.gram}G</td><td>${fmt(it.koli)}</td><td>${fmt(it.kg)}</td></tr>`).join('')}</tbody>
      </table>
      <p>Toplam Koli: ${fmt(o.totalKoli)} ‚Äì Toplam Kg: ${fmt(o.totalKg)}</p>
    `;
    document.getElementById('orderModal').classList.add('show');
  }
  async function deleteOrder(code){
    if(!confirm('Sipari≈üi silmek istediƒüinize emin misiniz?'))return;
    await loadOrders();
    orders=orders.filter(o=>o.code!==code);
    await writeGitHubFile('orders.json',JSON.stringify(orders,null,2),`Sipari≈ü silindi: ${code}`);
    openMyOrders();
  }
  function shareOrderFrom(code){
    const text=`Sipari≈ü Kodum: ${code}`;
    const url=`https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(url,'_blank');
  }

  window.onload=async()=>{
    setLang(lang);
    await loadOrders();
    loadProducts();
  };
</script>
</body>
</html>
